CREATE TYPE public.mejoras_metodosolicitud_enum AS ENUM ('escrito','verbal');

CREATE TABLE public.mejoras (
    id_mejora uuid DEFAULT public.uuid_generate_v4() PRIMARY KEY,
    codigo character varying(50) NOT NULL UNIQUE,
    "metodoSolicitud" public.mejoras_metodosolicitud_enum NOT NULL,
    "codigoAutorizacion" character varying(150),
    entidad character varying(150),
    "direccionEntidad" character varying(200),
    "panteoneroACargo" character varying(150),
    id_nicho uuid NOT NULL,
    id_solicitante uuid NOT NULL,
    id_fallecido uuid,
    "solicitanteDireccion" character varying(200),
    "solicitanteCorreo" character varying(100),
    "solicitanteTelefono" character varying(30),
    "observacionSolicitante" character varying(200),
    "propietarioNombre" character varying(200),
    "propietarioFechaAdquisicion" date,
    "propietarioTipoTenencia" character varying(50),
    "administradorNicho" character varying(120),
    "tipoServicio" character varying(120) NOT NULL,
    "observacionServicio" text,
    "fechaInicio" date NOT NULL,
    "fechaFin" date NOT NULL,
    "horarioTrabajo" character varying(120),
    condicion character varying(200),
    "autorizacionTexto" character varying(200),
    "normativaAplicable" character varying(200),
    "obligacionesPostObra" character varying(200),
    "escombreraMunicipal" character varying(200),
    aprobado boolean DEFAULT false,
    aprobado_por uuid,
    "fechaAprobacion" timestamp,
    estado character varying(40) DEFAULT 'Solicitado',
    fecha_creacion timestamp DEFAULT now(),
    fecha_actualizacion timestamp
);

ALTER TABLE public.mejoras
  ADD CONSTRAINT fk_mejoras_nicho
    FOREIGN KEY (id_nicho) REFERENCES public.nichos(id_nicho);

ALTER TABLE public.mejoras
  ADD CONSTRAINT fk_mejoras_solicitante
    FOREIGN KEY (id_solicitante) REFERENCES public.personas(id_persona);

ALTER TABLE public.mejoras
  ADD CONSTRAINT fk_mejoras_fallecido
    FOREIGN KEY (id_fallecido) REFERENCES public.personas(id_persona);

ALTER TABLE public.mejoras
  ADD CONSTRAINT fk_mejoras_aprobado_por
    FOREIGN KEY (aprobado_por) REFERENCES public."User"(id_user);

CREATE INDEX IF NOT EXISTS idx_mejoras_nicho ON public.mejoras (id_nicho);
CREATE INDEX IF NOT EXISTS idx_mejoras_solicitante ON public.mejoras (id_solicitante);